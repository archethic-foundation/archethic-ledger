#include "archethic.h"

// uint8_t masterSeed[] = {0x9A, 0x34, 0xA2, 0x33, 0xC4, 0x8B, 0x77, 0xD4, 0x88, 0x56, 0xED, 0x17, 0x17, 0x92, 0xD0, 0xB1, 0x67, 0xF5, 0x0D, 0x9A, 0x81, 0x48, 0x76, 0x9E, 0x00, 0x0D, 0x1F, 0x3C, 0x75, 0xF7, 0x4C, 0x15};
// uint8_t masterSeed[] = {0x6f, 0xa7, 0x74, 0x71, 0x8b, 0x0f, 0x08, 0x61, 0x01, 0xe7, 0xa0, 0xbf, 0x43, 0xf8, 0x19, 0x44, 0xf2, 0xee, 0xa0, 0x39, 0x2b, 0xc3, 0x45, 0x2a, 0xc3, 0x14, 0xcc, 0x44, 0x4f, 0x19, 0x97, 0x89, 0x89, 0xc6, 0x2b, 0xe4, 0x11, 0x0f, 0x8f, 0xd3, 0xe5, 0x43, 0x87, 0x5e, 0x9f, 0x3f, 0xe2, 0xe2, 0x24, 0x0f, 0x55, 0x4c, 0xf1, 0x6c, 0xfe, 0xbf, 0x67, 0x3b, 0x11, 0x2a, 0xc4, 0x4e, 0xc0, 0x16};

void deriveArchEthicKeyPair(uint32_t keyIndex, cx_ecfp_private_key_t *privateKey, cx_ecfp_public_key_t *publicKey)
{
    uint8_t keySeed[32];
    cx_ecfp_private_key_t walletPrivateKey;

    // bip32 path for 44'/650'/n'/0'/0'
    uint32_t bip32Path[] = {44 | 0x80000000, 650 | 0x80000000, keyIndex | 0x80000000, 0x80000000, 0x80000000};

    // Derive the seed for given path
    os_perso_derive_node_bip32(CX_CURVE_256K1, bip32Path, 5, keySeed, NULL);
    // archethic_derive_node_bip32(CX_CURVE_256K1, masterSeed, sizeof(masterSeed), bip32Path, 5, keySeed, NULL);

    // Initiate the private key with the seed
    cx_ecfp_init_private_key(CX_CURVE_256K1, keySeed, 32, &walletPrivateKey);

    if (publicKey)
    {
        // Derive the corresponding public key
        cx_ecfp_init_public_key(CX_CURVE_256K1, NULL, 0, publicKey);
        cx_ecfp_generate_pair(CX_CURVE_256K1, publicKey, &walletPrivateKey, 1);
    }
    if (privateKey)
    {
        *privateKey = walletPrivateKey;
    }
    explicit_bzero(keySeed, sizeof(keySeed));
    explicit_bzero(&walletPrivateKey, sizeof(walletPrivateKey));
}
